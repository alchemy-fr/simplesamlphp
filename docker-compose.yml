version: "3.4"

networks:
  internal:
    ipam:
      config:
        - subnet: 172.38.0.0/16

services:
  simplesamlphp-gateway:
    image: $DOCKER_REGISTRY/simplesamlphp-nginx:$DOCKER_TAG
    build:
      context: .
      target: simplesamlphp-nginx
    restart: on-failure
    depends_on:
    - simplesamlphp
    ports:
      - ${SIMPLESAML_PORT}:80
    volumes:
    - $SIMPLESAML_CONFIG_DIR:/var/simplesamlphp/config:rw
    - $SIMPLESAML_METADATA_DIR:/var/simplesamlphp/metadata:rw
    - $SIMPLESAML_CERTIFICATE_DIR:/var/simplesamlphp/cert:rw
    networks:
      - internal

  simplesamlphp:
    image: $DOCKER_REGISTRY/simplesamlphp-fpm:$DOCKER_TAG
    build:
      context: .
      target: simplesamlphp
    restart: on-failure
    volumes:
    - $SIMPLESAML_CONFIG_DIR:/var/simplesamlphp/config:rw
    - $SIMPLESAML_METADATA_DIR:/var/simplesamlphp/metadata:rw
    - $SIMPLESAML_CERTIFICATE_DIR:/var/simplesamlphp/cert:rw
    networks:
      - internal
